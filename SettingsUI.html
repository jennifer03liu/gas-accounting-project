<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <!-- 1. Add TinyMCE script -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        body { font-family: 'Roboto', 'Microsoft JhengHei', sans-serif; padding: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input[type="text"], input[type="email"] { width: 95%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        button { padding: 12px 20px; background-color: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #357ae8; }
        .preview-btn { background-color: #6c757d; font-size: 14px; padding: 8px 12px; margin-left: 10px; }
        .preview-btn:hover { background-color: #5a6268; }
        #status { margin-top: 15px; font-style: italic; color: green; font-weight: bold; }
        .template-section { border-top: 2px dashed #eee; padding-top: 15px; }
        .label-container { display: flex; align-items: center; justify-content: space-between; width: 95%; }
        #loader { text-align: center; padding-top: 80px; font-size: 16px; color: #666; }
        .preview-view-container { position: relative; padding-top: 50px; }
        .back-btn-container { position: absolute; top: 0px; left: 0px; }
        .back-btn { padding: 5px 12px; font-size: 14px; cursor: pointer; border: 1px solid #ccc; border-radius: 20px; background-color: #f1f1f1; font-weight: bold; color: black; }
        .back-btn:hover { background-color: #e0e0e0; }
        .preview-content-area { border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9; min-height: 400px; }
    </style>
</head>
<body>
    <div id="loader"><p>載入設定中，請稍候...</p></div>
    <div id="main-content" style="display: none;">
        <h3>郵件自動化參數設定</h3>
        <div class="form-group">
            <label for="recipient">收件者 Email (必填，多人請用逗號 , 分隔)</label>
            <input type="email" id="recipient">
        </div>
        <div class="form-group">
            <label for="senderName" id="senderNameLabel">寄件人顯示名稱</label>
            <input type="text" id="senderName">
        </div>

        <!-- Template for Jan-Nov -->
        <div class="form-group template-section">
            <div class="label-container">
                <label for="mainContentNormal">信件內文 (1-11月範本)</label>
                <button class="preview-btn" onclick="previewEmail('normal')">預覽</button>
            </div>
            <textarea id="mainContentNormal"></textarea>
        </div>

        <!-- Template for Dec -->
        <div class="form-group template-section">
            <div class="label-container">
                <label for="mainContentDecember">信件內文 (12月範本)</label>
                <button class="preview-btn" onclick="previewEmail('december')">預覽</button>
            </div>
            <textarea id="mainContentDecember"></textarea>
        </div>

        <button onclick="saveSettings()">儲存設定</button>
        <div id="status"></div>
    </div>

    <div id="preview-view" class="preview-view-container" style="display: none;">
        <div class="back-btn-container">
            <button class="back-btn" onclick="closePreview()">返回設定</button>
        </div>
        <div id="preview-content-area" class="preview-content-area"></div>
    </div>

    <script>
      // 2. Initialize TinyMCE
      tinymce.init({
        selector: 'textarea',
        plugins: 'autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount',
        toolbar: 'undo redo | blocks | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | link | help',
        height: 450,
        content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }',
        setup: function (editor) {
            editor.on('init', function () {
                // This is a hack to wait for TinyMCE to be ready
                // A better solution would use a proper callback or promise
                setTimeout(loadInitialContent, 100);
            });
        }
      });

      function loadInitialContent() {
        google.script.run.withSuccessHandler(function(data) {
            const settings = data.properties;
            const defaultSenderName = data.defaultSenderName;

            const senderNameLabel = document.getElementById('senderNameLabel');
            senderNameLabel.textContent = `寄件人顯示名稱 (選填，留空則使用預設名稱: ${defaultSenderName})`;

            document.getElementById('recipient').value = settings.recipient || 'tfgroup@trendforce.com,tritaipei@trendforce.com,tngroup@trendforce.com';
            document.getElementById('senderName').value = settings.senderName || '';

            // 3. Define full HTML default content
            const defaultNormalContent = `<p>Dear All,</p><p>{{rocYear}}年{{currentMonth}}月份尚未請款的個人費用(代墊款、差旅費等)及廠商款項申請,<br>請於{{deadlineDate}}前送至會計處，若有來不及請款的同仁請先與我們聯絡,</p><p><span style="background-color:yellow; color:red; font-weight:bold;">即日起不受理逾期款項延後請款，遇假日則順延至次一工作日繳交，還請各位幫忙配合，感謝!!</span></p><br><p><span style="background-color:yellow; font-weight:bold;">請款注意事項：</span></p><p>l&nbsp;&nbsp;&nbsp;公司相關請款表單，請至雲端公檔查詢 <a href="https://drive.google.com/drive/folders/1mErE9a4yBYffjIMtOpqZg6x_axGFZF3Y?usp=drive_link" target="_blank">https://drive.google.com/drive/folders/1mErE9a4yBYffjIMtOpqZg6x_axGFZF3Y</a></p><p>l&nbsp;&nbsp;&nbsp;發票抬頭：各請款公司別的公司名稱及統一編號請注意不要打錯</p><p>l&nbsp;&nbsp;&nbsp;請款憑證金額及內容請先計算核對</p><p>l&nbsp;&nbsp;&nbsp;如果有任何問題可以先查詢我們的管理中心小幫手 — <a href="https://notebooklm.google.com/notebook/fab65873-d66f-4bda-8ba4-4cff5a576d19" target="_blank">管理中心小幫手</a></p>`;
            const defaultDecemberContent = `<p>Dear All,</p><p>{{rocYear}}年即將結束，請大家可以提前將{{currentMonth}}月份尚未請款的個人費用(代墊款、差旅費等)及廠商款項先送出來申請。</p><p>另外，接近年底拿到的發票請注意若是{{nextRocYear}}年的不能拿來申請{{rocYear}}年的費用。</p><p>請於{{nextRocYear}}年1月5日前送至會計處，若有來不及請款的同仁請先與我們聯絡。</p><p><span style="background-color:yellow; color:red; font-weight:bold;">即日起不受理逾期款項延後請款，遇假日則順延至次一工作日繳交， 還請各位幫忙配合， 感謝!!</span></p><br><p><span style="background-color:yellow; font-weight:bold;">請款注意事項：</span></p><p>l&nbsp;&nbsp;&nbsp;公司相關請款表單，請至雲端公檔查詢 <a href="https://drive.google.com/drive/folders/1mErE9a4yBYffjIMtOpqZg6x_axGFZF3Y?usp=drive_link" target="_blank">https://drive.google.com/drive/folders/1mErE9a4yBYffjIMtOpqZg6x_axGFZF3Y</a></p><p>l&nbsp;&nbsp;&nbsp;發票抬頭：各請款公司別的公司名稱及統一編號請注意不要打錯</p><p>l&nbsp;&nbsp;&nbsp;請款憑證金額及內容請先計算核對</p><p>l&nbsp;&nbsp;&nbsp;如果有任何問題可以先查詢我們的管理中心小幫手 — <a href="https://notebooklm.google.com/notebook/fab65873-d66f-4bda-8ba4-4cff5a576d19" target="_blank">管理中心小幫手</a></p>`;

            // Use tinymce.get to set content. Check if editor is initialized.
            if (tinymce.get('mainContentNormal')) {
                tinymce.get('mainContentNormal').setContent(settings.mainContentNormal || defaultNormalContent);
            }
            if (tinymce.get('mainContentDecember')) {
                tinymce.get('mainContentDecember').setContent(settings.mainContentDecember || defaultDecemberContent);
            }

            document.getElementById('loader').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        }).getSettings();
      }

      function saveSettings() {
        var statusDiv = document.getElementById('status');
        statusDiv.textContent = '儲存中...';
        
        // 4. Get content from TinyMCE
        var settings = {
          recipient: document.getElementById('recipient').value,
          senderName: document.getElementById('senderName').value,
          mainContentNormal: tinymce.get('mainContentNormal').getContent(),
          mainContentDecember: tinymce.get('mainContentDecember').getContent()
        };

        google.script.run.withSuccessHandler(function(response) {
            statusDiv.textContent = response;
            setTimeout(function(){ google.script.host.close(); }, 2000);
        }).saveSettings(settings);
      }

      function previewEmail(type) {
        // 5. Get content from TinyMCE for preview
        let templateHtml = (type === 'normal') 
            ? tinymce.get('mainContentNormal').getContent() 
            : tinymce.get('mainContentDecember').getContent();

        document.getElementById('loader').style.display = 'block';
        document.getElementById('main-content').style.display = 'none';

        google.script.run.withSuccessHandler(function(processedHtml) {
            document.getElementById('preview-content-area').innerHTML = processedHtml;
            document.getElementById('loader').style.display = 'none';
            document.getElementById('preview-view').style.display = 'block';
        }).generatePreviewHtml(templateHtml, type);
      }

      function closePreview() {
        document.getElementById('preview-view').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
      }
    </script>
</body>
</html>
