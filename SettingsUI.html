<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        body { font-family: 'Roboto', 'Microsoft JhengHei', sans-serif; padding: 20px; background-color: #f9f9f9; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input[type="text"], input[type="email"], textarea {
            width: 95%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
        }
        textarea {
            min-height: 400px; /* Increased height for full content */
            white-space: pre-wrap;
            font-family: 'Microsoft JhengHei', sans-serif;
            line-height: 1.5;
        }
        button { 
            padding: 12px 25px; 
            background-color: #4285F4; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: background-color 0.3s;
        }
        button:hover { background-color: #357ae8; }
        .action-btn { font-size: 14px; padding: 8px 15px; margin-left: 10px; }
        .preview-btn { background-color: #6c757d; }
        .preview-btn:hover { background-color: #5a6268; }
        .restore-btn { background-color: #ffc107; color: #212529; }
        .restore-btn:hover { background-color: #e0a800; }

        #status { margin-top: 15px; font-style: italic; color: #28a745; font-weight: bold; }
        .template-section { border-top: 2px solid #eee; padding-top: 20px; margin-top: 20px; }
        .label-container { display: flex; align-items: center; justify-content: space-between; width: 95%; }
        .label-buttons { display: flex; gap: 10px; }
        
        /* Updated format instructions */
        .format-instructions {
            font-size: 13px;
            color: #333;
            background-color: #fff8dc; /* lightgoldenrodyellow */
            border-left: 5px solid #ff6b35; /* orange */
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            line-height: 1.6;
        }
        .format-instructions h4 { margin-top: 0; font-size: 16px; color: #d2691e; font-weight: bold; }
        .format-instructions code { background-color: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', Courier, monospace; color: #d63384; }
        .format-instructions .warning { color: #cc0000; font-weight: bold; background-color: #ffeeee; padding: 8px; border-radius: 3px; margin: 8px 0; }
        .format-instructions .tip { font-weight: bold; color: #0066cc; }
        .format-instructions ul { margin: 8px 0; padding-left: 20px; }
        .format-instructions li { margin: 5px 0; }
        
        #loader { text-align: center; padding-top: 80px; font-size: 16px; color: #666; }
        .preview-view-container { position: relative; padding-top: 50px; }
        .back-btn-container { position: absolute; top: 0px; left: 0px; }
        .back-btn { padding: 5px 12px; font-size: 14px; cursor: pointer; border: 1px solid #ccc; border-radius: 20px; background-color: #f1f1f1; font-weight: bold; color: black; }
        .back-btn:hover { background-color: #e0e0e0; }
        .preview-content-area { border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #fff; min-height: 400px; }
    </style>
</head>
<body>
    <div id="loader"><p>è¼‰å…¥è¨­å®šä¸­ï¼Œè«‹ç¨å€™...</p></div>
    <div id="main-content" style="display: none;">
        <h3>éƒµä»¶è‡ªå‹•åŒ–åƒæ•¸è¨­å®š</h3>
        <div class="form-group">
            <label for="recipient">æ”¶ä»¶è€… Email (å¿…å¡«ï¼Œå¤šäººè«‹ç”¨é€—è™Ÿ , åˆ†éš”)</label>
            <input type="email" id="recipient">
        </div>
        <div class="form-group">
            <label for="senderName" id="senderNameLabel">å¯„ä»¶äººé¡¯ç¤ºåç¨±</label>
            <input type="text" id="senderName">
        </div>
        <!-- Template for Jan-Nov -->
        <div class="form-group template-section">
            <div class="label-container">
                <label>ä¿¡ä»¶ç¯„æœ¬ (1-11æœˆ)</label>
                <div class="label-buttons">
                    <button class="action-btn restore-btn" onclick="restoreDefaults('normal')">é‚„åŸé è¨­å…§å®¹</button>
                    <button class="action-btn preview-btn" onclick="previewEmail('normal')">é è¦½</button>
                </div>
            </div>
            <label for="subjectNormal" style="font-weight:normal; margin-top:10px;">ä¸»æ—¨</label>
            <input type="text" id="subjectNormal">
            <label for="bodyNormal" style="font-weight:normal; margin-top:10px;">å…§æ–‡</label>
            <textarea id="bodyNormal"></textarea>
            <div class="format-instructions">
                <h4>âš ï¸ é‡è¦èªªæ˜ - è«‹ä»”ç´°é–±è®€</h4>
                <div class="warning">
                    â— ä»¥ä¸‹æ ¼å¼æ¨™è¨˜å’Œè®Šæ•¸è«‹å‹¿éš¨æ„æ›´æ”¹ï¼Œå¦å‰‡å¯èƒ½å°è‡´æ ¼å¼éŒ¯èª¤ï¼š
                </div>
                
                <p class="tip">ğŸ¨ ç‰¹æ®Šæ ¼å¼æ¨™è¨˜ï¼š</p>
                <ul>
                    <li><code>**ç´…å­—**æ‚¨çš„æ–‡å­—**ç´…å­—**</code> â†’ <span style="background-color:#ffff00; color:#cc0000; font-weight:bold;">é»ƒåº•ç´…å­—ç²—é«”</span> (ç”¨æ–¼é‡è¦è­¦å‘Š)</li>
                    <li><code>**é»ƒåº•**æ‚¨çš„æ–‡å­—**é»ƒåº•**</code> â†’ <span style="background-color:#ffff00; color:#000000; font-weight:bold;">é»ƒåº•é»‘å­—ç²—é«”</span> (ç”¨æ–¼æ¨™é¡Œ)</li>
                    <li><code>**æ‚¨çš„æ–‡å­—**</code> â†’ <strong>ä¸€èˆ¬ç²—é«”</strong></li>
                    <li><code>[é¡¯ç¤ºæ–‡å­—](ç¶²å€)</code> â†’ <a href="#">è¶…é€£çµ</a></li>
                    <li><code>l   é …ç›®å…§å®¹</code> æˆ– <code>â€¢   é …ç›®å…§å®¹</code> â†’ é …ç›®ç¬¦è™Ÿæ¸…å–®</li>
                </ul>
                
                <p class="tip">ğŸ”„ è‡ªå‹•æ›¿æ›è®Šæ•¸ (è«‹ä¿æŒä¸è®Š)ï¼š</p>
                <ul>
                    <li><code>{{rocYear}}</code> â†’ ç•¶å‰æ°‘åœ‹å¹´ (ä¾‹ï¼š113)</li>
                    <li><code>{{currentMonth}}</code> â†’ ç•¶å‰æœˆä»½ (ä¾‹ï¼š8)</li>
                    <li><code>{{deadlineDate}}</code> â†’ ä¸‹æœˆ5æ—¥æœŸé™ (ä¾‹ï¼š113å¹´9æœˆ5æ—¥)</li>
                </ul>
                
                <p class="tip">ğŸ’¡ ä½¿ç”¨å»ºè­°ï¼š</p>
                <ul>
                    <li>ä¿®æ”¹å…§å®¹æ™‚è«‹ä¿æŒç¾æœ‰çš„æ ¼å¼æ¨™è¨˜</li>
                    <li>è®Šæ•¸ {{}} å…§çš„æ–‡å­—è«‹å‹¿æ›´æ”¹</li>
                    <li>ä¿®æ”¹å¾Œå»ºè­°å…ˆæŒ‰ã€Œé è¦½ã€ç¢ºèªæ•ˆæœ</li>
                </ul>
            </div>
        </div>
        <!-- Template for Dec -->
        <div class="form-group template-section">
            <div class="label-container">
                <label>ä¿¡ä»¶ç¯„æœ¬ (12æœˆ)</label>
                <div class="label-buttons">
                    <button class="action-btn restore-btn" onclick="restoreDefaults('december')">é‚„åŸé è¨­å…§å®¹</button>
                    <button class="action-btn preview-btn" onclick="previewEmail('december')">é è¦½</button>
                </div>
            </div>
            <label for="subjectDecember" style="font-weight:normal; margin-top:10px;">ä¸»æ—¨</label>
            <input type="text" id="subjectDecember">
            <label for="bodyDecember" style="font-weight:normal; margin-top:10px;">å…§æ–‡</label>
            <textarea id="bodyDecember"></textarea>
            <div class="format-instructions">
                <h4>âš ï¸ é‡è¦èªªæ˜ - è«‹ä»”ç´°é–±è®€</h4>
                <div class="warning">
                    â— æ ¼å¼æ¨™è¨˜ä½¿ç”¨æ–¹å¼åŒä¸Šï¼Œè«‹å‹¿éš¨æ„æ›´æ”¹
                </div>
                <p class="tip">ğŸ”„ 12æœˆå°ˆç”¨è®Šæ•¸ï¼š</p>
                <ul>
                    <li><code>{{rocYear}}</code> â†’ ç•¶å‰æ°‘åœ‹å¹´</li>
                    <li><code>{{currentMonth}}</code> â†’ ç•¶å‰æœˆä»½ (12)</li>
                    <li><code>{{nextRocYear}}</code> â†’ æ˜å¹´æ°‘åœ‹å¹´ (ä¾‹ï¼š114)</li>
                </ul>
            </div>
        </div>
        <button onclick="saveSettings()">å„²å­˜è¨­å®š</button>
        <div id="status"></div>
    </div>
    <div id="preview-view" class="preview-view-container" style="display: none;">
        <div class="back-btn-container">
            <button class="back-btn" onclick="closePreview()">è¿”å›è¨­å®š</button>
        </div>
        <div id="preview-content-area" class="preview-content-area"></div>
    </div>
    <script>
      // Define defaults in a scope accessible by all functions
      let defaultSubjectNormal, defaultBodyNormal, defaultSubjectDecember, defaultBodyDecember;

      window.onload = function() {
        google.script.run.withSuccessHandler(function(data) {
            if (!data || !data.properties) {
                document.getElementById('loader').innerHTML = '<p style="color:red;">éŒ¯èª¤ï¼šç„¡æ³•å¾å¾Œç«¯è¼‰å…¥è¨­å®šã€‚è«‹æª¢æŸ¥æ—¥èªŒã€‚</p>';
                return;
            }
            const settings = data.properties;
            const defaultSenderName = data.defaultSenderName;
            const senderNameLabel = document.getElementById('senderNameLabel');
            senderNameLabel.textContent = `å¯„ä»¶äººé¡¯ç¤ºåç¨± (é¸å¡«ï¼Œç•™ç©ºå‰‡ä½¿ç”¨é è¨­åç¨±: ${defaultSenderName})`;
            document.getElementById('recipient').value = settings.recipient || 'tfgroup@trendforce.com,tritaipei@trendforce.com,tngroup@trendforce.com';
            document.getElementById('senderName').value = settings.senderName || '';
            
            // æ–°çš„é è¨­å…§å®¹ - å®Œæ•´ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰æ ¼å¼æ¨™è¨˜
            defaultSubjectNormal = 'ã€é€šçŸ¥ã€‘{{rocYear}}å¹´{{currentMonth}}æœˆæ¬¾é …ç”³è«‹(è‡³{{deadlineDate}}å‰æˆªæ­¢)';
            defaultBodyNormal = "**Dear All,**\n\n**{{rocYear}}å¹´{{currentMonth}}æœˆä»½å°šæœªè«‹æ¬¾çš„å€‹äººè²»ç”¨(ä»£å¢Šæ¬¾ã€å·®æ—…è²»ç­‰)åŠå» å•†æ¬¾é …ç”³è«‹ï¼Œ\nè«‹æ–¼{{deadlineDate}}å‰é€è‡³æœƒè¨ˆè™•ï¼Œè‹¥æœ‰ä¾†ä¸åŠè«‹æ¬¾çš„åŒä»è«‹å…ˆèˆ‡æˆ‘å€‘è¯çµ¡ï¼Œ\nå¦‚æœæœ‰å•é¡Œå¯ä»¥å…ˆæŸ¥è©¢æˆ‘å€‘çš„ç®¡ç†ä¸­å¿ƒå°å¹«æ‰‹, è£¡é¢å¯ä»¥æŸ¥åˆ°å…¬å¸ç›¸é—œçš„HRã€è²¡æœƒåŠè¡Œæ”¿ç­‰ç›¸é—œè³‡è¨Š â€” [ç®¡ç†ä¸­å¿ƒå°å¹«æ‰‹](https://notebooklm.google.com/notebook/fab65873-d66f-4bda-8ba4-4cff5a576d19),**\n\n**ç´…å­—**å³æ—¥èµ·ä¸å—ç†é€¾æœŸæ¬¾é …å»¶å¾Œè«‹æ¬¾ï¼Œé‡å‡æ—¥å‰‡é †å»¶è‡³æ¬¡ä¸€å·¥ä½œæ—¥ç¹³äº¤ï¼Œé‚„è«‹å„ä½å¹«å¿™é…åˆï¼Œæ„Ÿè¬!!**ç´…å­—**\n\n**é»ƒåº•**è«‹æ¬¾æ³¨æ„äº‹é …ï¼š**é»ƒåº•**\nl   å…¬å¸ç›¸é—œè«‹æ¬¾è¡¨å–®ï¼Œè«‹è‡³é›²ç«¯å…¬æª”æŸ¥è©¢ [é»æ­¤é€£çµ](https://drive.google.com/drive/folders/1mErE9a4yBYffjIMtOpqZg6x_axGFZF3Y)\nl   ç™¼ç¥¨æŠ¬é ­ï¼šå„è«‹æ¬¾å…¬å¸åˆ¥çš„å…¬å¸åç¨±åŠçµ±ä¸€ç·¨è™Ÿè«‹æ³¨æ„ä¸è¦æ‰“éŒ¯\nl   è«‹æ¬¾æ†‘è­‰é‡‘é¡åŠå…§å®¹è«‹å…ˆè¨ˆç®—æ ¸å°";
            
            defaultSubjectDecember = 'ã€é€šçŸ¥ã€‘{{rocYear}}å¹´{{currentMonth}}æœˆæ¬¾é …ç”³è«‹';
            defaultBodyDecember = "**Dear All,**\n\n**{{rocYear}}å¹´å³å°‡çµæŸï¼Œè«‹å¤§å®¶å¯ä»¥æå‰å°‡{{currentMonth}}æœˆä»½å°šæœªè«‹æ¬¾çš„å€‹äººè²»ç”¨(ä»£å¢Šæ¬¾ã€å·®æ—…è²»ç­‰)åŠå» å•†æ¬¾é …å…ˆé€å‡ºä¾†ç”³è«‹ã€‚**\n\n**å¦å¤–ï¼Œæ¥è¿‘å¹´åº•æ‹¿åˆ°çš„ç™¼ç¥¨è«‹æ³¨æ„è‹¥æ˜¯{{nextRocYear}}å¹´çš„ä¸èƒ½æ‹¿ä¾†ç”³è«‹{{rocYear}}å¹´çš„è²»ç”¨ã€‚**\n\n**è«‹æ–¼{{nextRocYear}}å¹´1æœˆ5æ—¥å‰é€è‡³æœƒè¨ˆè™•ï¼Œè‹¥æœ‰ä¾†ä¸åŠè«‹æ¬¾çš„åŒä»è«‹å…ˆèˆ‡æˆ‘å€‘è¯çµ¡ã€‚**\n**å¦‚æœæœ‰ä»»ä½•å•é¡Œå¯ä»¥å…ˆæŸ¥è©¢æˆ‘å€‘çš„ç®¡ç†ä¸­å¿ƒå°å¹«æ‰‹ â€” [ç®¡ç†ä¸­å¿ƒå°å¹«æ‰‹](https://notebooklm.google.com/notebook/fab65873-d66f-4bda-8ba4-4cff5a576d19)**\n**ç´…å­—**å³æ—¥èµ·ä¸å—ç†é€¾æœŸæ¬¾é …å»¶å¾Œè«‹æ¬¾ï¼Œé‡å‡æ—¥å‰‡é †å»¶è‡³æ¬¡ä¸€å·¥ä½œæ—¥ç¹³äº¤ï¼Œé‚„è«‹å„ä½å¹«å¿™é…åˆï¼Œæ„Ÿè¬!!**ç´…å­—**\n\n**é»ƒåº•**è«‹æ¬¾æ³¨æ„äº‹é …ï¼š**é»ƒåº•**\nl   å…¬å¸ç›¸é—œè«‹æ¬¾è¡¨å–®ï¼Œè«‹è‡³é›²ç«¯å…¬æª”æŸ¥è©¢ [é»æ­¤é€£çµ](https://drive.google.com/drive/folders/1mErE9a4yBYffjIMtOpqZg6x_axGFZF3Y)\nl   ç™¼ç¥¨æŠ¬é ­ï¼šå„è«‹æ¬¾å…¬å¸åˆ¥çš„å…¬å¸åç¨±åŠçµ±ä¸€ç·¨è™Ÿè«‹æ³¨æ„ä¸è¦æ‰“éŒ¯\nl   è«‹æ¬¾æ†‘è­‰é‡‘é¡åŠå…§å®¹è«‹å…ˆè¨ˆç®—æ ¸å°";
            
            document.getElementById('subjectNormal').value = settings.subjectNormal || defaultSubjectNormal;
            document.getElementById('bodyNormal').value = settings.bodyNormal || defaultBodyNormal;
            document.getElementById('subjectDecember').value = settings.subjectDecember || defaultSubjectDecember;
            document.getElementById('bodyDecember').value = settings.bodyDecember || defaultBodyDecember;
            document.getElementById('loader').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        }).getSettings();
      };
      function saveSettings() {
        var statusDiv = document.getElementById('status');
        statusDiv.textContent = 'å„²å­˜ä¸­...';
        
        var settings = {
          recipient: document.getElementById('recipient').value,
          senderName: document.getElementById('senderName').value,
          subjectNormal: document.getElementById('subjectNormal').value,
          bodyNormal: document.getElementById('bodyNormal').value,
          subjectDecember: document.getElementById('subjectDecember').value,
          bodyDecember: document.getElementById('bodyDecember').value
        };
        google.script.run.withSuccessHandler(function(response) {
            statusDiv.textContent = response;
            setTimeout(function(){ google.script.host.close(); }, 2000);
        }).withFailureHandler(function(error) {
            statusDiv.textContent = 'å„²å­˜å¤±æ•—: ' + error.message;
        }).saveSettings(settings);
      }
      function previewEmail(type) {
        let subject, body;
        if (type === 'normal') {
            subject = document.getElementById('subjectNormal').value;
            body = document.getElementById('bodyNormal').value;
        } else {
            subject = document.getElementById('subjectDecember').value;
            body = document.getElementById('bodyDecember').value;
        }
        document.getElementById('loader').style.display = 'block';
        document.getElementById('main-content').style.display = 'none';
        google.script.run.withSuccessHandler(function(processedHtml) {
            document.getElementById('preview-content-area').innerHTML = processedHtml;
            document.getElementById('loader').style.display = 'none';
            document.getElementById('preview-view').style.display = 'block';
        }).withFailureHandler(function(error) {
            document.getElementById('loader').innerHTML = `<p style="color:red;">é è¦½ç”¢ç”Ÿå¤±æ•—: ${error.message}</p>`;
        }).generatePreviewHtml({ subject: subject, body: body }, type);
      }
      function closePreview() {
        document.getElementById('preview-view').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
      }

      function restoreDefaults(type) {
        const confirmMessage = type === 'normal' 
            ? 'æ‚¨ç¢ºå®šè¦å°‡ã€Œ1-11æœˆã€çš„ç¯„æœ¬é‚„åŸç‚ºé è¨­å…§å®¹å—ï¼Ÿç›®å‰çš„ä¿®æ”¹å°‡æœƒéºå¤±ã€‚'
            : 'æ‚¨ç¢ºå®šè¦å°‡ã€Œ12æœˆã€çš„ç¯„æœ¬é‚„åŸç‚ºé è¨­å…§å®¹å—ï¼Ÿç›®å‰çš„ä¿®æ”¹å°‡æœƒéºå¤±ã€‚';
        
        if (confirm(confirmMessage)) {
            if (type === 'normal') {
                document.getElementById('subjectNormal').value = defaultSubjectNormal;
                document.getElementById('bodyNormal').value = defaultBodyNormal;
            } else {
                document.getElementById('subjectDecember').value = defaultSubjectDecember;
                document.getElementById('bodyDecember').value = defaultBodyDecember;
            }
        }
      }
    </script>
</body>
</html>